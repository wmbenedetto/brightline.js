/** @license Brightline.js | MIT License | https://github.com/wmbenedetto/brightline.js#mit-license */(function(e,t){var u=function(e){if(typeof e=="object"&&e!==null){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}return typeof e=="undefined"||e===null||e===""},a=function(e,t){for(var n=0;n<t.length;n++)if(e===t[n])return!0;return!1},f=function(e){return typeof e=="object"&&e!==null&&typeof e.length=="number"},l=function(e){return typeof e=="object"&&e!==null&&typeof e.length!="number"},c=function(e,t,n){t=typeof t=="undefined"?[]:t,n=typeof n=="undefined"?{}:n;var r,i,s;for(var o in e)e.hasOwnProperty(o)&&(r=o,i=e[o],t.push(r),typeof i=="object"&&i!==null?n=c(i,t,n):(s=t.join("."),n[s]=i),t.pop());return n},h=function(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")};Function.prototype.bind=function(e){var t=this;return function(){return t.apply(e,arguments)}};var p=function(t){this.name=t,this.content="",this.touched=0,this.variables=[],this.parsedContent=[],this.variableCache={},this.usedVariables={}};p.prototype={NODE_ID:null,name:null,content:null,touched:null,variables:null,parsedContent:null,variableCache:null,usedVariables:null,reset:function(){this.parsedContent=[],this.usedVariables={},this.touched=0},isAlreadyParsed:function(e){return e in this.usedVariables},getName:function(){return this.name},getParsedContent:function(){return this.parsedContent},addParsedContent:function(e){this.parsedContent.push(e)},setParsedContent:function(e){this.parsedContent=e},getContent:function(){return this.content},setContent:function(e){this.content=e},setVariables:function(e){this.variables=e},getVariables:function(){return this.variables},setTouched:function(e){this.touched=e},touch:function(){this.touched+=1},getTouched:function(){return this.touched},getVariableCache:function(){return this.variableCache},setUsedVariable:function(e,t){this.usedVariables[e]=t},getNodeID:function(){return this.getName()}};var d=function(){this.childParentMap={},this.nodes={},this.numNodes=0,this.tree={}};d.prototype={childParentMap:null,nodes:null,numNodes:null,tree:null,log:function(e,t,n,r){},addNode:function(e,t){this.nodes[t]=e,this.numNodes+=1},getNode:function(e){return this.hasNode(e)?this.nodes[e]:null},getNodes:function(e){if(e){var t={};for(var n=0;n<e.length;n++)t[e[n]]=this.getNode(e[n]);return t}return this.nodes},removeNode:function(e){if(this.hasNode(e)){try{delete this.nodes[e]}catch(n){this.nodes[e]=t}this.numNodes-=1}},hasNode:function(e){return e in this.nodes},isEmpty:function(){for(var e in this.nodes)if(this.nodes.hasOwnProperty(e))return!1;return!0},has:function(e){return this.hasNode(e)},getNodeID:function(e){if(typeof e=="string"||typeof e=="number")return e;if(typeof e=="object"&&e!==null&&typeof e.getNodeID=="function")return e.getNodeID();throw new Error("[Tree.getNodeID()] Cannot get node ID")},addChild:function(e,t){var n=this.getNodeID(e),r=this.getNodeID(t);if(this.hasParent(t))throw new Error("[Tree.addChild()] Child node "+r+" already has a parent");if(n===r)throw new Error("[Tree.addChild()] Parent and child node are the same. You cannot add a parent node as a child of itself, or vice-versa.");if(this.hasNode(r))throw new Error("[Tree.addChild()] The nodeID "+r+" is already in use");this.hasNode(n)||this.addNode(e,n),this.log("addChild","Adding child",{parent:e,child:t},"DEBUG"),this.addNode(t,r),n in this.tree||(this.tree[n]=[]),this.tree[n].push(r),this.childParentMap[r]=n},addChildren:function(e,t){if(!f(t))throw new Error("[Tree.addChildren()] Children added to Tree must in an array");for(var n=0;n<t.length;n++)this.addChild(e,t[n])},getChild:function(e){if(!this.hasNode(e))throw new Error("[Tree.getChild()] Cannot get non-existent node "+e+" from Tree");return this.getNode(e)},getChildren:function(e){var t=this.getNodeID(e);return t in this.tree?this.getNodes(this.tree[t]):{}},hasChild:function(e,t){var n=this.getNodeID(e),r=this.getNodeID(t);return r in this.childParentMap?n===this.childParentMap[r]:!1},hasChildren:function(e){var t=this.getNodeID(e);return t in this.tree&&this.tree[t].length>0},removeChild:function(e,n){if(!this.isChildOf(e,n))throw new Error("[Tree.removeChild()] Cannot remove child. This node is not a child of the given parent.");var r=this.getNodeID(e),i=this.getNodeID(n),s=this.tree[r];for(var o=0;o<s.length;o++)if(s[o]===i){s.splice(o,1);break}try{delete this.childParentMap[i]}catch(u){this.childParentMap[i]=t}if(s.length===0)try{delete this.tree[r]}catch(u){this.tree[r]=t}this.removeNode(i),this.hasChildren(i)&&this.removeChildren(i)},removeChildren:function(e,t){typeof t=="undefined"&&this.hasChildren(e)&&(t=this.getChildren(e));for(var n in t)t.hasOwnProperty(n)&&this.removeChild(e,t[n])},isChildOf:function(e,t){return this.hasChild(e,t)},addParent:function(e){if(!this.isEmpty())throw new Error("[Tree.addParent()] Cannot add lone parent to a Tree that already has nodes in it. Use Tree.addChild(parent,child) instead.");var t=this.getNodeID(e);if(this.hasNode(t))throw new Error("[Tree.addParent()] Parent's node id must be unique.");this.addNode(e,t),t in this.tree||(this.tree[t]=[])},getParent:function(e){if(!this.hasParent(e))return!1;var t=this.getParentNodeID(e);return this.getNode(t)},hasParent:function(e){var t=this.getParentNodeID(e);return t!==null},getParentNodeID:function(e){var t=null;if((typeof e=="string"||typeof e=="number")&&e in this.childParentMap)t=this.childParentMap[e];else if(typeof e=="object"&&e!==null&&typeof e.getNodeID=="function"){var n=e.getNodeID();t=n in this.childParentMap?this.childParentMap[n]:null}return t},isParent:function(e){return this.hasChildren(e)},remove:function(e){var t=this.getNodeID(e);if(this.hasParent(t)){var n=this.getParent(t);this.removeChild(n,e)}else this.isParent(e)&&this.removeChildren(e);this.removeNode(t)}};var v=function(t,n){return this.blocks=new d,this.currentBlock=null,this.currentScope=null,this.usedVariables={},this.variableCache={},l(n)&&(r=n.logLevel||"ERROR",this.name=n.name||null),typeof t=="string"&&this.process(t),this.getAPI()};v.prototype={blocks:null,currentBlock:null,currentScope:null,name:null,usedVariables:null,variableCache:null,getAPI:function(){return{set:this.set.bind(this),setScope:this.setScope.bind(this),clearScope:this.clearScope.bind(this),touch:this.touch.bind(this),parse:this.parse.bind(this),render:this.render.bind(this),snip:this.snip.bind(this),setLogLevel:this.setLogLevel.bind(this),setName:this.setName.bind(this),each:this.each.bind(this)}},setLogLevel:function(e){r=e},setName:function(e){this.name=e},log:function(e,t,n,r){},set:function(){var e=Array.prototype.slice.call(arguments),t=null,n=null,r=!1;return l(e[0])?(t=e[0],r=e[1],this.setObjectVars(t,r)):(t=e[0],n=e[1],r=e[2],typeof n=="function"?n=n():typeof n=="undefined"&&(n=null),this.isValidKeyValuePair(t,n)&&(this.currentScope===null||r?this.variableCache[t]=n:this.currentScope.variableCache[t]=n)),this},each:function(){var e=Array.prototype.slice.call(arguments),t=e[0],n=e[1],r=null,i=null;typeof e[2]=="string"?r=e[2]:typeof e[2]=="function"&&(i=e[2]),!i&&typeof e[3]=="function"&&(i=e[3]);for(var s in t)t.hasOwnProperty(s)&&(l(t[s])?this.set(t[s]):r&&this.set(r,t[s]),i&&i(t[s],s),this.parse(n))},setScope:function(e){if(!this.hasBlock(e))throw new Error("["+this.name+" Brightline.setScope()] Cannot set scope to non-existent block: "+e);return this.currentScope=this.getBlock(e),this},clearScope:function(e){return e=typeof e=="undefined"?!0:e,!e&&this.currentScope!==null&&(this.currentScope.variableCache={},this.currentScope.usedVariables={}),e&&(this.currentScope=null),this},touch:function(e){var t=this.getBlock(e);return t.touch(),this},parse:function(e,t){e=typeof e=="undefined"?"__root__":e,t=typeof t=="undefined"?!0:t;var n=this.getBlock(e);return t?n.setTouched(1):n.setTouched(0),this.currentBlock=n.getName(),this.parseBlock(n),this.clearUsedVariablesFromCache(),this.clearScope(!1),n.setTouched(0),this.currentBlock="__root__",n},render:function(e){e=typeof e=="undefined"?"__root__":e;var t=this.parse(e),n=h(t.getParsedContent().join("\n"));return this.clearScope(),t.reset(),n},snip:function(e){e=typeof e=="undefined"?"__root__":e;var t=this.parse(e,!1),n=t.getParsedContent(),r=h(n.join("\n"));return r.length===0&&(r=t.getContent()),n=n.slice(0,0-t.getTouched()),t.setParsedContent(n),this.clearScope(),r},setObjectVars:function(e,t){var n=c(e);for(var r in n)n.hasOwnProperty(r)&&this.set(r,n[r],t)},getBlock:function(e){if(!this.hasBlock(e))throw new Error("["+this.name+" Brightline.getBlock()] Cannot get non-existent block: "+e);return this.blocks.getChild(e)},hasBlock:function(e){return this.blocks.has(e)},process:function(e){var t=new p("__root__");t.setContent(e),this.findBlocks(t),this.insertChildBlockPlaceholders(t),this.findVariablesInBlockContent(t),this.blocks.has("__root__")||this.blocks.addParent(t)},findBlocks:function(e){var t=/<!--\s+BEGIN\s+([\.0-9A-Za-z:|_-]+)\s+-->([\s\S]*)<!--\s+END\s+\1\s+-->/mg,n=e.getContent(),r=n.match(t),i=this;if(r)for(var s=0;s<r.length;s++){var o=(new RegExp(t)).exec(r[s]);if(o){var u=o[1],a=new p(u);a.setContent(o[2]);if(i.blocks.has(u))throw new Error("["+this.name+" Brightline.findBlocks()] Duplicate block name: "+u+". Block names must be unique.");i.blocks.addChild(e,a),i.findBlocks(a),i.insertChildBlockPlaceholders(a),i.findVariablesInBlockContent(a)}}},insertChildBlockPlaceholders:function(e){if(this.blocks.hasChildren(e)){var t=this.blocks.getChildren(e),n=this;for(var r in t)t.hasOwnProperty(r)&&function(t){var r=t.getName(),i=e.getContent(),s="<!--\\s+BEGIN\\s+"+r+"\\s+-->([\\s\\S]*)<!--\\s+END\\s+"+r+"\\s+-->",o=i.match(s);o&&e.setContent(i.replace(o[0],"{{__"+r+"__}}"))}(t[r])}},findVariablesInBlockContent:function(e){var t=/(?!\{{__[\.0-9A-Za-z\*:|_-]+__\}})\{{([\.0-9A-Za-z\*:|_-]+)\}}/mg,n=[],r=e.getContent().match(t);if(r){for(var i=0;i<r.length;i++)if(!a(n,r[i])){var s=r[i].replace("{{","").replace("}}","");n.push(s)}e.setVariables(n)}},parseBlock:function(e){var t=this.blocks.getChildren(e);for(var n in t)t.hasOwnProperty(n)&&this.parseBlock(t[n]);return this.currentBlock=e.getName(),this.replaceBlockVariables(e),this.replaceChildBlockPlaceholders(e),e.setTouched(0),e},replaceBlockVariables:function(e){var t=e.getContent(),n=e.getVariables(),r=e.getName(),i=e.getVariableCache();if(n.length>0)for(var s=0;s<n.length;s++){var o=n[s],u="{{"+o+"}}";r===this.currentBlock?o in i?(t=t.replace(u,i[o]),e.setUsedVariable(o,!0),e.touched=1):o in this.variableCache&&!e.isAlreadyParsed(o)?(t=t.replace(u,this.variableCache[o]),this.usedVariables[o]=!0,e.touched=1):t=t.replace(u,""):t=t.replace(u,"")}var a=e.getTouched();for(var f=0;f<a;f++)e.addParsedContent(t)},replaceChildBlockPlaceholders:function(e){var t=this.getParsedContent(e),n=this.blocks.getChildren(e);if(!u(n)){for(var r in n)if(n.hasOwnProperty(r)){var i="{{__"+n[r].getName()+"__}}",s=h(n[r].parsedContent.join(""));for(var o in t)t.hasOwnProperty(o)&&t[o].indexOf(i)>-1&&(t[o]=t[o].replace(i,s));n[r].parsedContent=[]}e.setParsedContent(t)}},getParsedContent:function(e){if(e.parsedContent.length===0&&this.blocks.hasChildren(e)){var t=this.blocks.getChildren(e);for(var n in t)if(t.hasOwnProperty(n)&&t[n].parsedContent.length>0){this.touch(e.getName()),this.replaceBlockVariables(e);break}}return e.getParsedContent()},clearUsedVariablesFromCache:function(){for(var e in this.usedVariables)if(this.usedVariables.hasOwnProperty(e))try{delete this.variableCache[e]}catch(n){this.variableCache[e]=t}this.usedVariables=[]},isValidKeyValuePair:function(e,t){return typeof e=="string"&&(typeof t=="string"&&t.length>0||typeof t=="number"||typeof t=="boolean")}},typeof define=="function"?define(function(){return v}):e.Brightline=v})(window);