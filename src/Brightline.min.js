/** @license Brightline.js | MIT License | https://github.com/wmbenedetto/brightline.js#mit-license */(function(e,t){var u=function(e){if(typeof e=="object"&&e!==null){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}return typeof e=="undefined"||e===null||e===""},a=function(e){return typeof e=="object"&&e!==null&&typeof e.length!="number"},f=function(e,t,n){t=typeof t=="undefined"?[]:t,n=typeof n=="undefined"?{}:n;var r,i,s;for(var o in e)e.hasOwnProperty(o)&&(r=o,i=e[o],t.push(r),typeof i=="object"&&i!==null?n=f(i,t,n):(s=t.join("."),n[s]=i),t.pop());return n},l=function(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")};typeof Function.prototype.bind!="function"&&(Function.prototype.bind=function(e){var t=this;return function(){return t.apply(e,arguments)}});var c=function(t){this.name=t,this.content="",this.touches=0,this.variables=[],this.parsedContent=[],this.variableCache={},this.usedVariables={}};c.prototype={NODE_ID:null,name:null,content:null,touches:null,variables:null,parsedContent:null,variableCache:null,usedVariables:null,reset:function(){this.parsedContent=[],this.usedVariables={},this.touches=0},touch:function(){this.touches+=1},setUsedVariable:function(e,t){this.usedVariables[e]=t},getNodeID:function(){return this.name}};var h=function(){this.childParentMap={},this.nodes={},this.numNodes=0,this.tree={}};h.prototype={childParentMap:null,nodes:null,numNodes:null,tree:null,log:function(e,t,n,r){},addNode:function(e,t){this.nodes[t]=e,this.numNodes+=1},getNode:function(e){return this.hasNode(e)?this.nodes[e]:null},getNodes:function(e){if(e){var t={};for(var n=0;n<e.length;n++)t[e[n]]=this.getNode(e[n]);return t}return this.nodes},removeNode:function(e){if(this.hasNode(e)){try{delete this.nodes[e]}catch(n){this.nodes[e]=t}this.numNodes-=1}},hasNode:function(e){return e in this.nodes},isEmpty:function(){for(var e in this.nodes)if(this.nodes.hasOwnProperty(e))return!1;return!0},has:function(e){return this.hasNode(e)},getNodeID:function(e){if(typeof e=="string"||typeof e=="number")return e;if(typeof e=="object"&&e!==null&&typeof e.getNodeID=="function")return e.getNodeID();throw new Error("[Tree.getNodeID()] Cannot get node ID")},addChild:function(e,t){var n=this.getNodeID(e),r=this.getNodeID(t);if(this.hasParent(t))throw new Error("[Tree.addChild()] Child node "+r+" already has a parent");if(n===r)throw new Error("[Tree.addChild()] Parent and child node are the same. You cannot add a parent node as a child of itself, or vice-versa.");if(this.hasNode(r))throw new Error("[Tree.addChild()] The nodeID "+r+" is already in use");this.hasNode(n)||this.addNode(e,n),this.log("addChild","Adding child",{parent:e,child:t},"DEBUG"),this.addNode(t,r),n in this.tree||(this.tree[n]=[]),this.tree[n].push(r),this.childParentMap[r]=n},addChildren:function(e,t){if(typeof t!="object"||t===null||typeof t.length!="number")throw new Error("[Tree.addChildren()] Children added to Tree must in an array");for(var n=0;n<t.length;n++)this.addChild(e,t[n])},getChild:function(e){if(!this.hasNode(e))throw new Error("[Tree.getChild()] Cannot get non-existent node "+e+" from Tree");return this.getNode(e)},getChildren:function(e){var t=this.getNodeID(e);return t in this.tree?this.getNodes(this.tree[t]):{}},hasChild:function(e,t){var n=this.getNodeID(e),r=this.getNodeID(t);return r in this.childParentMap?n===this.childParentMap[r]:!1},hasChildren:function(e){var t=this.getNodeID(e);return t in this.tree&&this.tree[t].length>0},removeChild:function(e,n){if(!this.isChildOf(e,n))throw new Error("[Tree.removeChild()] Cannot remove child. This node is not a child of the given parent.");var r=this.getNodeID(e),i=this.getNodeID(n),s=this.tree[r];for(var o=0;o<s.length;o++)if(s[o]===i){s.splice(o,1);break}try{delete this.childParentMap[i]}catch(u){this.childParentMap[i]=t}if(s.length===0)try{delete this.tree[r]}catch(u){this.tree[r]=t}this.removeNode(i),this.hasChildren(i)&&this.removeChildren(i)},removeChildren:function(e,t){typeof t=="undefined"&&this.hasChildren(e)&&(t=this.getChildren(e));for(var n in t)t.hasOwnProperty(n)&&this.removeChild(e,t[n])},isChildOf:function(e,t){return this.hasChild(e,t)},addParent:function(e){if(!this.isEmpty())throw new Error("[Tree.addParent()] Cannot add lone parent to a Tree that already has nodes in it. Use Tree.addChild(parent,child) instead.");var t=this.getNodeID(e);if(this.hasNode(t))throw new Error("[Tree.addParent()] Parent's node id must be unique.");this.addNode(e,t),t in this.tree||(this.tree[t]=[])},getParent:function(e){if(!this.hasParent(e))return!1;var t=this.getParentNodeID(e);return this.getNode(t)},hasParent:function(e){var t=this.getParentNodeID(e);return t!==null},getParentNodeID:function(e){var t=null;if((typeof e=="string"||typeof e=="number")&&e in this.childParentMap)t=this.childParentMap[e];else if(typeof e=="object"&&e!==null&&typeof e.getNodeID=="function"){var n=e.getNodeID();t=n in this.childParentMap?this.childParentMap[n]:null}return t},isParent:function(e){return this.hasChildren(e)},remove:function(e){var t=this.getNodeID(e);if(this.hasParent(t)){var n=this.getParent(t);this.removeChild(n,e)}else this.isParent(e)&&this.removeChildren(e);this.removeNode(t)}};var p=function(t,n){return this.blocks=new h,this.currentBlock=null,this.currentScope=null,this.usedVariables={},this.variableCache={},a(n)&&(r=n.logLevel||"ERROR",this.name=n.name||null),typeof t=="string"&&this.process(t),this.getAPI()};p.prototype={blocks:null,currentBlock:null,currentScope:null,name:null,usedVariables:null,variableCache:null,getAPI:function(){return{set:this.set.bind(this),setScope:this.setScope.bind(this),clearScope:this.clearScope.bind(this),touch:this.touch.bind(this),parse:this.parse.bind(this),render:this.render.bind(this),snip:this.snip.bind(this),setLogLevel:this.setLogLevel.bind(this),setName:this.setName.bind(this)}},setLogLevel:function(e){r=e},setName:function(e){this.name=e},log:function(e,t,n,r){},set:function(){var e=Array.prototype.slice.call(arguments),t=null,n=null,r=!1;return a(e[0])?(t=e[0],r=e[1],this.setObjectVars(t,r)):(t=e[0],n=e[1],r=e[2],typeof n=="function"?n=n():typeof n=="undefined"&&(n=null),this.isValidKeyValuePair(t,n)&&(this.currentScope===null||r?this.variableCache[t]=n:this.currentScope.variableCache[t]=n)),this},setScope:function(e){return this.currentScope=this.getBlock(e),this},clearScope:function(e){return e=typeof e=="undefined"?!0:e,!e&&this.currentScope!==null&&(this.currentScope.variableCache={},this.currentScope.usedVariables={}),e&&(this.currentScope=null),this},touch:function(e){return this.getBlock(e).touch(),this},parse:function(e,t){e=typeof e=="undefined"?"__root__":e,t=typeof t=="undefined"?!0:t;var n=this.getBlock(e);return n.touches=t?1:0,this.currentBlock=n.name,this.parseBlock(n),this.clearUsedVariablesFromCache(),this.clearScope(!1),n.touches=0,this.currentBlock="__root__",n},render:function(e){e=typeof e=="undefined"?"__root__":e,this.parse(e);var t=this.getBlock(e),n=l(t.parsedContent.join("\n"));return this.clearScope(),t.reset(),n},snip:function(e){e=typeof e=="undefined"?"__root__":e,this.parse(e,!1);var t=this.getBlock(e),n=l(t.parsedContent.join("\n"));return n.length===0&&(n=t.content),t.parsedContent=t.parsedContent.slice(0,0-t.touches),this.clearScope(),n},setObjectVars:function(e,t){var n=f(e);for(var r in n)n.hasOwnProperty(r)&&this.set(r,n[r],t)},getBlock:function(e){if(!this.blocks.has(e))throw new Error("["+this.name+" Brightline.getBlock()] Cannot get non-existent block: "+e);return this.blocks.getChild(e)},process:function(e){var t=new c("__root__");t.content=e,this.findBlocks(t),this.insertChildBlockPlaceholders(t),this.findVariablesInBlockContent(t),this.blocks.has("__root__")||this.blocks.addParent(t)},findBlocks:function(e){var t=/<!--\s+BEGIN\s+([\.0-9A-Za-z:|_-]+)\s+-->([\s\S]*)<!--\s+END\s+\1\s+-->/gm,n=e.content.match(t),r=this;if(n)for(var i=0;i<n.length;i++){var s=(new RegExp(t)).exec(n[i]);if(s){var o=s[1],u=new c(o);u.content=s[2];if(r.blocks.has(o))throw new Error("["+this.name+" Brightline.findBlocks()] Duplicate block name: "+o+". Block names must be unique.");r.blocks.addChild(e,u),r.findBlocks(u),r.insertChildBlockPlaceholders(u),r.findVariablesInBlockContent(u)}}},insertChildBlockPlaceholders:function(e){if(this.blocks.hasChildren(e)){var t=e.content,n=this.blocks.getChildren(e),r=this;for(var i in n)n.hasOwnProperty(i)&&function(n){var i=n.name,s="<!--\\s+BEGIN\\s+"+i+"\\s+-->([\\s\\S]*)<!--\\s+END\\s+"+i+"\\s+-->",o=t.match(s);o&&(e.content=t.replace(o[0],"{{__"+i+"__}}"))}(n[i])}},findVariablesInBlockContent:function(e){var t=/(?!\{{__[\.0-9A-Za-z\*:|_-]+__\}})\{{([\.0-9A-Za-z\*:|_-]+)\}}/mg,n={},r=e.content.match(t),i=[];if(r){for(var s=0;s<r.length;s++)if(!(r[s]in n)){var o=r[s].substring(2,r[s].length-2);n[o]=1,i.push(o)}e.variables=i}},parseBlock:function(e){var t=this.blocks.getChildren(e);for(var n in t)t.hasOwnProperty(n)&&this.parseBlock(t[n]);return this.currentBlock=e.name,this.replaceBlockVariables(e),this.replaceChildBlockPlaceholders(e),e.touches=0,e},replaceBlockVariables:function(e){var t=e.content,n=e.variables,r=n.length,i=e.name,s=e.variableCache,o=e.usedVariables,u=this.currentBlock,a=this.variableCache,f=this.usedVariables;if(r>0)for(var l=0;l<r;l++){var c=n[l],h="{{"+c+"}}";i===u?c in s?(t=t.replace(h,s[c]),e.setUsedVariable(c,!0),e.touches=1):c in a&&!(c in o)?(t=t.replace(h,a[c]),f[c]=!0,e.touches=1):t=t.replace(h,""):t=t.replace(h,"")}var p=e.touches;for(var d=0;d<p;d++)e.parsedContent.push(t)},replaceChildBlockPlaceholders:function(e){e.parsedContent.length===0&&this.blocks.hasChildren(e)&&this.parseChildBlockContent(e);var t=e.parsedContent,n=this.blocks.getChildren(e);if(!u(n))for(var r in n)if(n.hasOwnProperty(r)){var i="{{__"+n[r].name+"__}}",s=l(n[r].parsedContent.join(""));for(var o in t)t.hasOwnProperty(o)&&t[o].indexOf(i)>-1&&(t[o]=t[o].replace(i,s));n[r].parsedContent=[]}},parseChildBlockContent:function(e){var t=this.blocks.getChildren(e),n=!1;for(var r in t)if(t.hasOwnProperty(r)&&t[r].parsedContent.length>0){n=!0;break}n&&(e.touch(),this.replaceBlockVariables(e))},clearUsedVariablesFromCache:function(){var e=this.usedVariables,n=this.variableCache;for(var r in e)if(e.hasOwnProperty(r))try{delete n[r]}catch(i){n[r]=t}this.usedVariables=[]},isValidKeyValuePair:function(e,t){return typeof e=="string"&&(typeof t=="string"&&t.length>0||typeof t=="number"||typeof t=="boolean")}},typeof define=="function"?define(function(){return p}):e.Brightline=p})(window);